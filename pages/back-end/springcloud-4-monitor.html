<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>服务雪崩 | Tao&#39;s Docs</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.eb84dcc4.js" as="script"><link rel="preload" href="/assets/js/2.3438093d.js" as="script"><link rel="preload" href="/assets/js/13.b4785702.js" as="script"><link rel="prefetch" href="/assets/js/10.5c85d835.js"><link rel="prefetch" href="/assets/js/11.4e188f36.js"><link rel="prefetch" href="/assets/js/12.63bafc7d.js"><link rel="prefetch" href="/assets/js/14.f812d107.js"><link rel="prefetch" href="/assets/js/15.9292f8a4.js"><link rel="prefetch" href="/assets/js/16.c1fe50c7.js"><link rel="prefetch" href="/assets/js/17.b8c322d0.js"><link rel="prefetch" href="/assets/js/18.9d5b497f.js"><link rel="prefetch" href="/assets/js/19.02d9dbde.js"><link rel="prefetch" href="/assets/js/20.d41d055a.js"><link rel="prefetch" href="/assets/js/21.e546c67d.js"><link rel="prefetch" href="/assets/js/22.88d5c441.js"><link rel="prefetch" href="/assets/js/23.52b19eba.js"><link rel="prefetch" href="/assets/js/24.7cfd8490.js"><link rel="prefetch" href="/assets/js/25.b634aa65.js"><link rel="prefetch" href="/assets/js/26.e6adb331.js"><link rel="prefetch" href="/assets/js/27.0d5b7487.js"><link rel="prefetch" href="/assets/js/28.38896ef3.js"><link rel="prefetch" href="/assets/js/29.0d8a4197.js"><link rel="prefetch" href="/assets/js/3.1d9e5fa9.js"><link rel="prefetch" href="/assets/js/30.a6742e17.js"><link rel="prefetch" href="/assets/js/31.abc42197.js"><link rel="prefetch" href="/assets/js/32.a0586ff7.js"><link rel="prefetch" href="/assets/js/33.769cdb65.js"><link rel="prefetch" href="/assets/js/34.0ed6a7b5.js"><link rel="prefetch" href="/assets/js/35.05027a7e.js"><link rel="prefetch" href="/assets/js/36.9fe4cab0.js"><link rel="prefetch" href="/assets/js/37.f55cbcbb.js"><link rel="prefetch" href="/assets/js/38.9917a028.js"><link rel="prefetch" href="/assets/js/39.8ca4953b.js"><link rel="prefetch" href="/assets/js/4.b7d0708f.js"><link rel="prefetch" href="/assets/js/40.be762125.js"><link rel="prefetch" href="/assets/js/41.26af46d4.js"><link rel="prefetch" href="/assets/js/42.ee5b090a.js"><link rel="prefetch" href="/assets/js/43.336503df.js"><link rel="prefetch" href="/assets/js/44.dc926be6.js"><link rel="prefetch" href="/assets/js/45.6854943b.js"><link rel="prefetch" href="/assets/js/46.8e0d341a.js"><link rel="prefetch" href="/assets/js/47.f2e48103.js"><link rel="prefetch" href="/assets/js/48.72715128.js"><link rel="prefetch" href="/assets/js/49.44639b54.js"><link rel="prefetch" href="/assets/js/5.9e2f4ca7.js"><link rel="prefetch" href="/assets/js/50.6bcef58f.js"><link rel="prefetch" href="/assets/js/51.a78f9b9f.js"><link rel="prefetch" href="/assets/js/52.7fa6c2a6.js"><link rel="prefetch" href="/assets/js/53.72d89890.js"><link rel="prefetch" href="/assets/js/54.9ee5a5d0.js"><link rel="prefetch" href="/assets/js/55.d39bc266.js"><link rel="prefetch" href="/assets/js/56.57eec7c3.js"><link rel="prefetch" href="/assets/js/57.759b950d.js"><link rel="prefetch" href="/assets/js/58.dba62ed6.js"><link rel="prefetch" href="/assets/js/59.b381d76a.js"><link rel="prefetch" href="/assets/js/6.c7b54f12.js"><link rel="prefetch" href="/assets/js/60.47666c3f.js"><link rel="prefetch" href="/assets/js/61.5f20b3e7.js"><link rel="prefetch" href="/assets/js/62.edaf0b01.js"><link rel="prefetch" href="/assets/js/63.101ed616.js"><link rel="prefetch" href="/assets/js/64.e81ca07d.js"><link rel="prefetch" href="/assets/js/65.eef3caa6.js"><link rel="prefetch" href="/assets/js/66.47e25e41.js"><link rel="prefetch" href="/assets/js/67.f61b31d4.js"><link rel="prefetch" href="/assets/js/68.d58f06f4.js"><link rel="prefetch" href="/assets/js/69.de63cbe4.js"><link rel="prefetch" href="/assets/js/7.f39602d3.js"><link rel="prefetch" href="/assets/js/70.e55a4ab9.js"><link rel="prefetch" href="/assets/js/71.340f0f17.js"><link rel="prefetch" href="/assets/js/72.efc7adcb.js"><link rel="prefetch" href="/assets/js/8.f49bd070.js"><link rel="prefetch" href="/assets/js/9.9ddd43a0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Tao's Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/back-end/introduction.html" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/pages/database/introduction.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/pages/tools/introduction.html" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/pages/dev-env/introduction.html" class="nav-link">
  环境搭建
</a></li></ul></div></div><div class="nav-item"><a href="https://yangtao.live/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/back-end/introduction.html" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/pages/database/introduction.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/pages/tools/introduction.html" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/pages/dev-env/introduction.html" class="nav-link">
  环境搭建
</a></li></ul></div></div><div class="nav-item"><a href="https://yangtao.live/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>页面介绍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>SpringCloud</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/back-end/springcloud-1-microservice.html" class="sidebar-link">微服务概述</a></li><li><a href="/pages/back-end/springcloud-2-register-center.html" class="sidebar-link">服务注册中心</a></li><li><a href="/pages/back-end/springcloud-3-communicate.html" class="sidebar-link">服务通信</a></li><li><a href="/pages/back-end/springcloud-4-monitor.html" aria-current="page" class="active sidebar-link">断路及监控</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#服务雪崩" class="sidebar-link">服务雪崩</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#过程" class="sidebar-link">过程</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#解决" class="sidebar-link">解决</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#hystrix" class="sidebar-link">Hystrix</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#概述-2" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#实践-下游" class="sidebar-link">实践——下游</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#实践-openfeign-hystrix" class="sidebar-link">实践——OpenFeign &amp; Hystrix</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#hystrix-dashboard" class="sidebar-link">Hystrix Dashboard</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#概述-3" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#实践" class="sidebar-link">实践</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-4-monitor.html#展望" class="sidebar-link">展望</a></li></ul></li></ul></li><li><a href="/pages/back-end/springcloud-5-gateway.html" class="sidebar-link">网关服务</a></li><li><a href="/pages/back-end/springcloud-6-config.html" class="sidebar-link">统一配置中心</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="服务雪崩"><a href="#服务雪崩" class="header-anchor">#</a> 服务雪崩</h2> <h3 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h3> <p>微服务在进行服务调用时，<strong>下游服务崩溃导致上级服务积压过多突发的请求</strong>，慢慢地，<strong>线程资源耗尽</strong>，服务崩溃，接着压力<strong>传递到更上一级服务</strong>，最终导致链路中<strong>所有服务都崩溃</strong>，即<strong>服务雪崩</strong>。</p> <h3 id="过程"><a href="#过程" class="header-anchor">#</a> 过程</h3> <img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220119200302699.png" alt="image-20220119200302699" style="zoom:67%;"> <ol><li>Service C突然崩溃，导致Service B积压过多的请求，没有释放资源</li> <li>Service B由于资源耗尽，进而崩溃，导致Service A积压过多请求</li> <li>Service A也耗尽资源，崩溃</li> <li>链路中所有自C开始的上游服务全部崩溃</li></ol> <h3 id="解决"><a href="#解决" class="header-anchor">#</a> 解决</h3> <h4 id="服务熔断"><a href="#服务熔断" class="header-anchor">#</a> 服务熔断</h4> <p>当发现某个服务异常的时候，直接熔断整个服务，给上游服务（调用者）返回一个友好的错误提示，以此防止上游服务线程阻塞、耗尽资源、崩溃、进而引发雪崩效应（这有点类似家里的保险丝，用电功率过大保险丝就熔断，防止发生意外）；等待目标服务情况好转，主机有更多的空闲资源了，则继续恢复调用。</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220119201204390.png" alt="image-20220119201204390"></p> <h4 id="服务降级"><a href="#服务降级" class="header-anchor">#</a> 服务降级</h4> <p>当服务压力剧增的时候根据当前的业务情况对一些服务和页面有策略的降级，缓解服务器的压力，保证核心任务能够完成（如双十一下单高峰期，只保证能够完成下单，但是下单成功后跳转到指定页面这种边缘服务则无所谓，可直接返回一个友好的报错页面，让用户自行刷新查看）。</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220119203031308.png" alt="image-20220119203031308"></p> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <ol><li>服务熔断和服务降级<strong>都是为了系统的可行性考虑</strong></li> <li>熔断是出于<strong>服务故障</strong>而触发，而降级是出于系统的<strong>整体负荷</strong>和核心业务而触发</li> <li>熔断必定触发降级，所以<strong>熔断也是降级的一种</strong></li> <li>熔断是“<strong>处理</strong>”，降级是“<strong>预防</strong>”</li></ol> <h2 id="hystrix"><a href="#hystrix" class="header-anchor">#</a> Hystrix</h2> <h3 id="概述-2"><a href="#概述-2" class="header-anchor">#</a> 概述</h3> <blockquote><p>In a distributed environment, inevitably some of the many service dependencies will fail. Hystrix is a library that helps you control the interactions between these distributed services by adding latency tolerance and fault tolerance logic. Hystrix does this by isolating points of access between the services, stopping cascading failures across them, and providing fallback options, all of which improve your system’s overall resiliency.</p></blockquote> <ul><li><strong>adding latency tolerance and fault tolerance logic：添加延迟容忍和容错逻辑</strong></li> <li><strong>by isolating points of access between the services：分隔服务之间的访问点</strong></li> <li><strong>stopping cascading failures across them：停止跨服务的级联故障</strong></li> <li><strong>providing fallback options：提供回退选项</strong></li></ul> <h3 id="实践-下游"><a href="#实践-下游" class="header-anchor">#</a> 实践——下游</h3> <ol><li><p>快速创建SpringBoot项目，端口号10086，加入consul注册中心</p></li> <li><p>引入依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>入口类开启熔断功能</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token annotation punctuation">@EnableCircuitBreaker</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixApplication</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p>默认10s超过20个请求，或10s超过50%的请求失败则会将服务断开；现定义失败后的快速响应调用的方法（返回值和参数类型需对应），用抛出异常模拟服务调用失败</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;testFallBack&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>integer <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;模拟出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testFallBack</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;服务器繁忙，请稍后再试！&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>10s内连续请求失败后，断路器打开，服务熔断，对于正确的请求也会返回快速响应</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220119213243728.png" alt="image-20220119213243728"></p></li> <li><p>断路器打开条件：</p> <ul><li>10s内超20个请求次数</li> <li>10s内超50%的请求失败</li> <li>断路器打开5s后，进入半开状态，如果一个请求成功则关闭断路器，否则继续打开断路器</li></ul> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220119213945367.png" alt="image-20220119213945367"></p></li> <li><p>如果不想在@HystrixCommand中自定义处理方法，则可以指定默认的快速响应方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@HystrixCommand</span><span class="token punctuation">(</span>fallbackMethod <span class="token operator">=</span> <span class="token string">&quot;testFallBack&quot;</span><span class="token punctuation">,</span> defaultFallback <span class="token operator">=</span> <span class="token string">&quot;defaultFallBack&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>

<span class="token comment">//默认的快速响应方法，返回类型为String，空参</span>
<span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">defaultFallBack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;服务器繁忙，请稍后再试！&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="实践-openfeign-hystrix"><a href="#实践-openfeign-hystrix" class="header-anchor">#</a> 实践——OpenFeign &amp; Hystrix</h3> <ol><li><p>再新建一个SpringBoot项目，加入服务注册中心，端口为10087，引入OpenFeign（默认含Hystrix）</p></li> <li><p>配置文件开启hystrix支持</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">feign.hystrix.enabled</span><span class="token punctuation">=</span><span class="token attr-value">true</span>
</code></pre></div></li> <li><p>被调用的服务不做处理</p></li> <li><p>调用方Feign接口，@FeignClient注解指定fallback的值，为一个类</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@FeignClient</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;HYSTRIX&quot;</span><span class="token punctuation">,</span> fallback <span class="token operator">=</span> <span class="token class-name">HystrixClientFallBack</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">HystrixClient</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/test&quot;</span><span class="token punctuation">)</span>
    <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> integer<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>@FeignClient中fallback指定的类为Feign接口的实现类，重写的方法就是快速响应的方法</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixClientFallBack</span> <span class="token keyword">implements</span> <span class="token class-name">HystrixClient</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;服务器繁忙，请稍后再试！&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>调用方controller</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TestController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Qualifier</span><span class="token punctuation">(</span><span class="token string">&quot;com.yangtao.feign.HystrixClient&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">HystrixClient</span> hystrixClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span><span class="token string">&quot;integer&quot;</span><span class="token punctuation">)</span> <span class="token class-name">Integer</span> integer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> test <span class="token operator">=</span> hystrixClient<span class="token punctuation">.</span><span class="token function">test</span><span class="token punctuation">(</span>integer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> test<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>当满足断路器开启条件时，即使被调用方不开启断路器支持，调用方也会开启断路器</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220119221720495.png" alt="image-20220119221720495"></p></li></ol> <h2 id="hystrix-dashboard"><a href="#hystrix-dashboard" class="header-anchor">#</a> Hystrix Dashboard</h2> <h3 id="概述-3"><a href="#概述-3" class="header-anchor">#</a> 概述</h3> <p>Hystrix仪表盘，收集了关于<strong>每个HystrixCommand的度量</strong>，以图形化界面显示每个断路器的运行状况。</p> <p>使用时需要创建单独的springboot项目，该服务仅仅只有监控功能，因此没有必要加入注册中心。</p> <h3 id="实践"><a href="#实践" class="header-anchor">#</a> 实践</h3> <ol><li><p>创建springboot项目，端口为9888</p></li> <li><p>引入hystrix dashboard依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-netflix-hystrix-dashboard<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>入口类开启dashboard</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableHystrixDashboard</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixDashBoardApplication</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p>启动项目，访问图形化界面，http://localhost/hystrix</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220120082139565.png" alt="image-20220120082139565"></p></li> <li><p>坑1：被监控的项目中入口类或新建配置类，加入监控路径配置（否则找不到监控的服务），并启动监控项目</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Configuration</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixDashboardConfig</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ServletRegistrationBean</span> <span class="token function">getServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">HystrixMetricsStreamServlet</span> streamServlet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HystrixMetricsStreamServlet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">ServletRegistrationBean</span> registrationBean <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServletRegistrationBean</span><span class="token punctuation">(</span>streamServlet<span class="token punctuation">)</span><span class="token punctuation">;</span>
        registrationBean<span class="token punctuation">.</span><span class="token function">setLoadOnStartup</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registrationBean<span class="token punctuation">.</span><span class="token function">addUrlMappings</span><span class="token punctuation">(</span><span class="token string">&quot;/hystrix.stream&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        registrationBean<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;HystrixMetricsStreamServlet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> registrationBean<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>坑2：新版本中springcloud将jquery版本升级为3.4.1，所以需要修改monitor.ftlh文件，如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">load</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  修改为   <span class="token function">$</span><span class="token punctuation">(</span>window<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;load&quot;</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div></li> <li><p>\repository\org\springframework\cloud\spring-cloud-netflix-hystrix-dashboard\2.2.3.RELEASE</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220120085034155.png" alt="image-20220120085034155"></p></li> <li><p>监控路径去掉/actuator，如：http://localhost:10087/hystrix.stream</p></li> <li><p>调用服务，查看失败率，断路器是否打开</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220121005638286.png" alt="image-20220121005638286"></p></li></ol> <h3 id="展望"><a href="#展望" class="header-anchor">#</a> 展望</h3> <p>目前Hystrix DashBoard已经停止维护，所以存在较多未解决的bug，现在更推荐使用SpringCloud Alibaba的<strong>sentinel</strong>（后续更新~）。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/back-end/springcloud-3-communicate.html" class="prev">
        服务通信
      </a></span> <span class="next"><a href="/pages/back-end/springcloud-5-gateway.html">
        网关服务
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.eb84dcc4.js" defer></script><script src="/assets/js/2.3438093d.js" defer></script><script src="/assets/js/13.b4785702.js" defer></script>
  </body>
</html>
