<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>概述 | Tao&#39;s Docs</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.e4d8b86b.css" as="style"><link rel="preload" href="/assets/js/app.eb84dcc4.js" as="script"><link rel="preload" href="/assets/js/2.3438093d.js" as="script"><link rel="preload" href="/assets/js/11.4e188f36.js" as="script"><link rel="prefetch" href="/assets/js/10.5c85d835.js"><link rel="prefetch" href="/assets/js/12.63bafc7d.js"><link rel="prefetch" href="/assets/js/13.b4785702.js"><link rel="prefetch" href="/assets/js/14.f812d107.js"><link rel="prefetch" href="/assets/js/15.9292f8a4.js"><link rel="prefetch" href="/assets/js/16.c1fe50c7.js"><link rel="prefetch" href="/assets/js/17.b8c322d0.js"><link rel="prefetch" href="/assets/js/18.9d5b497f.js"><link rel="prefetch" href="/assets/js/19.02d9dbde.js"><link rel="prefetch" href="/assets/js/20.d41d055a.js"><link rel="prefetch" href="/assets/js/21.e546c67d.js"><link rel="prefetch" href="/assets/js/22.88d5c441.js"><link rel="prefetch" href="/assets/js/23.52b19eba.js"><link rel="prefetch" href="/assets/js/24.7cfd8490.js"><link rel="prefetch" href="/assets/js/25.b634aa65.js"><link rel="prefetch" href="/assets/js/26.e6adb331.js"><link rel="prefetch" href="/assets/js/27.0d5b7487.js"><link rel="prefetch" href="/assets/js/28.38896ef3.js"><link rel="prefetch" href="/assets/js/29.0d8a4197.js"><link rel="prefetch" href="/assets/js/3.1d9e5fa9.js"><link rel="prefetch" href="/assets/js/30.a6742e17.js"><link rel="prefetch" href="/assets/js/31.abc42197.js"><link rel="prefetch" href="/assets/js/32.a0586ff7.js"><link rel="prefetch" href="/assets/js/33.769cdb65.js"><link rel="prefetch" href="/assets/js/34.0ed6a7b5.js"><link rel="prefetch" href="/assets/js/35.05027a7e.js"><link rel="prefetch" href="/assets/js/36.9fe4cab0.js"><link rel="prefetch" href="/assets/js/37.f55cbcbb.js"><link rel="prefetch" href="/assets/js/38.9917a028.js"><link rel="prefetch" href="/assets/js/39.8ca4953b.js"><link rel="prefetch" href="/assets/js/4.b7d0708f.js"><link rel="prefetch" href="/assets/js/40.be762125.js"><link rel="prefetch" href="/assets/js/41.26af46d4.js"><link rel="prefetch" href="/assets/js/42.ee5b090a.js"><link rel="prefetch" href="/assets/js/43.336503df.js"><link rel="prefetch" href="/assets/js/44.dc926be6.js"><link rel="prefetch" href="/assets/js/45.6854943b.js"><link rel="prefetch" href="/assets/js/46.8e0d341a.js"><link rel="prefetch" href="/assets/js/47.f2e48103.js"><link rel="prefetch" href="/assets/js/48.72715128.js"><link rel="prefetch" href="/assets/js/49.44639b54.js"><link rel="prefetch" href="/assets/js/5.9e2f4ca7.js"><link rel="prefetch" href="/assets/js/50.6bcef58f.js"><link rel="prefetch" href="/assets/js/51.a78f9b9f.js"><link rel="prefetch" href="/assets/js/52.7fa6c2a6.js"><link rel="prefetch" href="/assets/js/53.72d89890.js"><link rel="prefetch" href="/assets/js/54.9ee5a5d0.js"><link rel="prefetch" href="/assets/js/55.d39bc266.js"><link rel="prefetch" href="/assets/js/56.57eec7c3.js"><link rel="prefetch" href="/assets/js/57.759b950d.js"><link rel="prefetch" href="/assets/js/58.dba62ed6.js"><link rel="prefetch" href="/assets/js/59.b381d76a.js"><link rel="prefetch" href="/assets/js/6.c7b54f12.js"><link rel="prefetch" href="/assets/js/60.47666c3f.js"><link rel="prefetch" href="/assets/js/61.5f20b3e7.js"><link rel="prefetch" href="/assets/js/62.edaf0b01.js"><link rel="prefetch" href="/assets/js/63.101ed616.js"><link rel="prefetch" href="/assets/js/64.e81ca07d.js"><link rel="prefetch" href="/assets/js/65.eef3caa6.js"><link rel="prefetch" href="/assets/js/66.47e25e41.js"><link rel="prefetch" href="/assets/js/67.f61b31d4.js"><link rel="prefetch" href="/assets/js/68.d58f06f4.js"><link rel="prefetch" href="/assets/js/69.de63cbe4.js"><link rel="prefetch" href="/assets/js/7.f39602d3.js"><link rel="prefetch" href="/assets/js/70.e55a4ab9.js"><link rel="prefetch" href="/assets/js/71.340f0f17.js"><link rel="prefetch" href="/assets/js/72.efc7adcb.js"><link rel="prefetch" href="/assets/js/8.f49bd070.js"><link rel="prefetch" href="/assets/js/9.9ddd43a0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e4d8b86b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Tao's Docs</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/back-end/introduction.html" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/pages/database/introduction.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/pages/tools/introduction.html" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/pages/dev-env/introduction.html" class="nav-link">
  环境搭建
</a></li></ul></div></div><div class="nav-item"><a href="https://yangtao.live/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分类" class="dropdown-title"><span class="title">分类</span> <span class="arrow down"></span></button> <button type="button" aria-label="分类" class="mobile-dropdown-title"><span class="title">分类</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/back-end/introduction.html" class="nav-link">
  后端
</a></li><li class="dropdown-item"><!----> <a href="/pages/database/introduction.html" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/pages/tools/introduction.html" class="nav-link">
  工具
</a></li><li class="dropdown-item"><!----> <a href="/pages/dev-env/introduction.html" class="nav-link">
  环境搭建
</a></li></ul></div></div><div class="nav-item"><a href="https://yangtao.live/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客主页
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>页面介绍</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>SpringCloud</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/back-end/springcloud-1-microservice.html" class="sidebar-link">微服务概述</a></li><li><a href="/pages/back-end/springcloud-2-register-center.html" aria-current="page" class="active sidebar-link">服务注册中心</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#概述" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#eureka" class="sidebar-link">Eureka</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#概述-2" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#eureka-server实践" class="sidebar-link">Eureka Server实践</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#验证" class="sidebar-link">验证</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#报错" class="sidebar-link">报错</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#eureka-client实践" class="sidebar-link">Eureka Client实践</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#验证-2" class="sidebar-link">验证</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#eureka的自我保护机制" class="sidebar-link">Eureka的自我保护机制</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#eureka-server集群搭建" class="sidebar-link">Eureka Server集群搭建</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#consul" class="sidebar-link">consul</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#概述-3" class="sidebar-link">概述</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#server实践" class="sidebar-link">Server实践</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#client实践" class="sidebar-link">Client实践</a></li></ul></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#eureka-vs-consul" class="sidebar-link">Eureka VS Consul</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#cap" class="sidebar-link">CAP</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#eureka-2" class="sidebar-link">Eureka</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#consul-2" class="sidebar-link">Consul</a></li><li class="sidebar-sub-header"><a href="/pages/back-end/springcloud-2-register-center.html#对比" class="sidebar-link">对比</a></li></ul></li></ul></li><li><a href="/pages/back-end/springcloud-3-communicate.html" class="sidebar-link">服务通信</a></li><li><a href="/pages/back-end/springcloud-4-monitor.html" class="sidebar-link">断路及监控</a></li><li><a href="/pages/back-end/springcloud-5-gateway.html" class="sidebar-link">网关服务</a></li><li><a href="/pages/back-end/springcloud-6-config.html" class="sidebar-link">统一配置中心</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h2> <p>在整个微服务架构单独抽取一个服务，该服务没有任何业务功能，仅用来完成整个微服务系统的<strong>服务注册</strong>、<strong>服务发现</strong>、<strong>服务健康状态的监控和管理</strong>、<strong>以及服务元数据信息存储</strong>。</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220116195504525.png" alt="image-20220116195504525"></p> <p><strong>具体作用：</strong></p> <ul><li>可以对所有的微服务的<strong>信息进行存储</strong>，如微服务的名称、IP、端口等。</li> <li>可以在进行服务调用时，通过服务发现<strong>查询可用的微服务列表及网络地址</strong>进行服务调用。</li> <li>可以对所有的微服务进行心跳检测，如发现某实例长时间无法访问，就会从服务注册表移除该实例。</li></ul> <h2 id="eureka"><a href="#eureka" class="header-anchor">#</a> Eureka</h2> <h3 id="概述-2"><a href="#概述-2" class="header-anchor">#</a> 概述</h3> <p>Eureka是Netflix开发的服务发现框架，本身是一个<strong>基于REST的服务</strong>。SpringCloud将它集成在其子项目spring-cloud-netflix中，以<strong>实现SpringCloud的服务注册和发现功能</strong>。eureka2.0版本目前已停止更新，1.0还在稳定使用。</p> <p>包含两个组件：<strong><code>Eureka Server</code></strong>、<strong><code>Eureka Client</code></strong></p> <h3 id="eureka-server实践"><a href="#eureka-server实践" class="header-anchor">#</a> Eureka Server实践</h3> <ol><li><p>创建SpringBoot项目</p></li> <li><p>引入Eureka的Maven依赖</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>server<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>编写配置文件</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token comment"># 指定服务端口</span>
<span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8761</span>
<span class="token comment"># 注意，服务名不能有下划线，且最好大写</span>
<span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">eurekaserver</span>
<span class="token comment"># 服务注册中心的地址</span>
<span class="token attr-name">eureka.client.service-url.defaultZone</span><span class="token punctuation">=</span><span class="token attr-value">http://localhost:8761/eureka</span>
</code></pre></div></li> <li><p>入口类加上开启EurekaServer的注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerApplication</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="验证"><a href="#验证" class="header-anchor">#</a> 验证</h3> <p>访问 http://localhost:8761/</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220116203608487.png" alt="image-20220116203608487"></p> <h3 id="报错"><a href="#报错" class="header-anchor">#</a> 报错</h3> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220116204333989.png" alt="image-20220116204333989"></p> <p>**原因：**eureka包含两个组件，包含eureka client，项目启动时会将自己作为客户端立即进行注册，注册时server还没准备完成，所以出现这个错误。</p> <p><strong>解决方案：</strong></p> <ol><li>关闭eureka client的立即注册</li> <li>让当前应用仅作为服务注册中心，不做客户端</li></ol> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">eureka.client.fetch-registry</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">eureka.client.register-with-eureka</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
</code></pre></div><h3 id="eureka-client实践"><a href="#eureka-client实践" class="header-anchor">#</a> Eureka Client实践</h3> <p>注：这里的eureka client模拟的是基于业务拆分出来的一个个微服务，实际开发并没有这种服务</p> <ol><li><p>创建SpringBoot项目</p></li> <li><p>引入Eureka的Maven依赖</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token generics"><span class="token punctuation">&lt;</span>dependency<span class="token punctuation">&gt;</span></span>
    <span class="token generics"><span class="token punctuation">&lt;</span>groupId<span class="token punctuation">&gt;</span></span>org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token operator">&lt;</span><span class="token operator">/</span>groupId<span class="token operator">&gt;</span>
    <span class="token generics"><span class="token punctuation">&lt;</span>artifactId<span class="token punctuation">&gt;</span></span>spring<span class="token operator">-</span>cloud<span class="token operator">-</span>starter<span class="token operator">-</span>netflix<span class="token operator">-</span>eureka<span class="token operator">-</span>client<span class="token operator">&lt;</span><span class="token operator">/</span>artifactId<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>dependency<span class="token operator">&gt;</span>
</code></pre></div></li> <li><p>编写配置文件</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8989</span>
<span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">EUREKACLIENT</span>
<span class="token comment"># 服务注册中心的地址</span>
<span class="token attr-name">eureka.client.service-url.defaultZone</span><span class="token punctuation">=</span><span class="token attr-value">http://localhost:8761/eureka</span>
</code></pre></div></li> <li><p>入口类加上开启EurekaClient的注解</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableEurekaClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">EurekaServerApplication</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div></li></ol> <h3 id="验证-2"><a href="#验证-2" class="header-anchor">#</a> 验证</h3> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220116210607084.png" alt="image-20220116210607084"></p> <h3 id="eureka的自我保护机制"><a href="#eureka的自我保护机制" class="header-anchor">#</a> Eureka的自我保护机制</h3> <p><strong><code>EMERGENCY! EUREKA MAY BE INCORRECTLY CLAIMING INSTANCES ARE UP WHEN THEY'RE NOT. RENEWALS ARE LESSER THAN THRESHOLD AND HENCE THE INSTANCES ARE NOT BEING EXPIRED JUST TO BE SAFE.</code></strong></p> <blockquote><p>Eureka servers will enter self preservation mode if they detect that a larger than expected number of registered clients have terminated their connections in an ungraceful way, and are pending eviction at the same time. This is done to ensure catastrophic network events do not wipe out eureka registry data, and having this be propagated downstream to all clients.</p> <p>To better understand self preservation, it help to first understand how does eureka clients 'end' their registration lifecycle. The eureka protocol requires clients to execute an explicit unregister action when they are permanently going away. For example, in the provided java client, this is done in the shutdown() method. any clients that fails 3 consecutive heartbeat renewals is considered to have an unclean termination, and will be evicted by the background eviction process. It is when &gt; 15% of the current registry is in this later state, that self preservation will be enabled.</p> <p>When in self preservation mode, eureka servers will stop eviction of all instances until either:</p> <ol><li>the number of heartbeat renewals it sees is back above the expected threshold, or</li> <li>self preservation is disabled (see below)</li></ol> <p>Self preservation is enabled by default, and the default threshold for enabling self preservation is &gt; 15% of the current registry size.</p></blockquote> <ol><li><p>自我保护机制<strong>默认开启</strong>（不开启的话90秒没有接收到某个服务的心跳就剔除该服务）</p></li> <li><p>工作机制：<strong>15分钟</strong>内超**85%**的客户节点都没有正常的心跳，那么Eureka Server就认为客户端与注册中心出现了网络故障，进入自我保护机制</p></li> <li><p>eureka不会因为没有收到某一次心跳而清除注册表</p></li> <li><p>自我保护模式下，停止清除注册表中的所有实例，<strong>宁可保留错误的注册信息，也不盲目注销可能健康的实例</strong></p></li> <li><p>关闭自我保护机制：</p> <p>server设置，且设置3000ms没有收到心跳就剔除该服务</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">eureka.server.enable-self-preservation</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
<span class="token attr-name">eureka.server.eviction-interval-timer-in-ms</span><span class="token punctuation">=</span><span class="token attr-value">3000</span>
</code></pre></div><p>关闭后会提示：<strong><code>THE SELF PRESERVATION MODE IS TURNED OFF. THIS MAY NOT PROTECT INSTANCE EXPIRY IN CASE OF NETWORK/OTHER PROBLEMS.</code></strong></p> <p>client设置，向server发送心跳的时间设置为1s（默认30），server收到最后一次心跳后等待时间上限设置为2s（默认90），即告诉server，2s没有收到我的心跳就把我剔除</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">eureka.instance.lease-renewal-interval-in-seconds</span><span class="token punctuation">=</span><span class="token attr-value">1</span>
<span class="token attr-name">eureka.instance.lease-expiration-duration-in-seconds</span><span class="token punctuation">=</span><span class="token attr-value">2</span>
</code></pre></div></li></ol> <h3 id="eureka-server集群搭建"><a href="#eureka-server集群搭建" class="header-anchor">#</a> Eureka Server集群搭建</h3> <p>拓扑图</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220116221308514.png" alt="image-20220116221308514"></p> <ol><li><p>复制3个Server项目，通过运行参数修改启动端口</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220116222327587.png" alt="image-20220116222327587"></p></li> <li><p>对每个复制的项目都修改配置文件（这里只写出节点1的配置）：节点1向节点2、3注册；节点2向节点1、3注册；节点3向节点1、2注册</p> <div class="language-java extra-class"><pre class="language-java"><code>eureka<span class="token punctuation">.</span>client<span class="token punctuation">.</span>service<span class="token operator">-</span>url<span class="token punctuation">.</span>defaultZone<span class="token operator">=</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9002</span><span class="token operator">/</span>eureka<span class="token punctuation">,</span>http<span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>localhost<span class="token operator">:</span><span class="token number">9003</span><span class="token operator">/</span>eureka
</code></pre></div></li> <li><p>client配置文件中，服务注册中心的地址填上3个eureka的地址</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">eureka.client.service-url.defaultZone</span><span class="token punctuation">=</span><span class="token attr-value">http://localhost:9001/eureka,http://localhost:9002/eureka,http://localhost:9003/eureka</span>
</code></pre></div></li> <li><p>启动，client会随机挑选一个服务注册中心</p></li> <li><p>当被client选中的服务注册中心宕机，若干秒以后，client会自动从另外两个服务注册中心中挑选一个作为服务注册中心，即完成了Eureka Server的集群搭建，实现了注册中心的高可用</p></li></ol> <h2 id="consul"><a href="#consul" class="header-anchor">#</a> consul</h2> <h3 id="概述-3"><a href="#概述-3" class="header-anchor">#</a> 概述</h3> <p>consul是一个可以提供<strong>服务发现</strong>，<strong>健康检查</strong>，<strong>多数据中心</strong>，Key/Value存储等功能的分布式服务框架，用于实现分布式系统的服务发现与配置。</p> <p>Consul用Golang实现，因此具有<strong>天然可移植性</strong>(支持Linux、Windows和Mac OS X)；安装包仅包含一个可执行文件，方便部署。</p> <p>官网：https://www.consul.io/</p> <h3 id="server实践"><a href="#server实践" class="header-anchor">#</a> Server实践</h3> <p>启动</p> <div class="language-bash extra-class"><pre class="language-bash"><code>consul agent -dev
</code></pre></div><p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220117133037161.png" alt="image-20220117133037161"></p> <ul><li><p>dc1为datacenter，默认为dc1，可以指定数据中心启动</p> <div class="language-bash extra-class"><pre class="language-bash"><code>consul agent -dev -datacenter dc2
</code></pre></div></li> <li><p>services：当前consul服务中注册的服务列表，默认会自己注册自己，即出现一个consul服务</p></li> <li><p>nodes：用来查看consul的集群节点</p></li></ul> <h3 id="client实践"><a href="#client实践" class="header-anchor">#</a> Client实践</h3> <ol><li><p>创建一个SpringBoot项目，引入consul-discovery依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-consul-discovery<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>配置文件指定consul-server服务注册中心的地址</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">server.port</span><span class="token punctuation">=</span><span class="token attr-value">8082</span>
<span class="token attr-name">spring.application.name</span><span class="token punctuation">=</span><span class="token attr-value">CONSULCLIENT</span>
<span class="token comment"># 服务注册中心的地址及端口</span>
<span class="token attr-name">spring.cloud.consul.host</span><span class="token punctuation">=</span><span class="token attr-value">localhost</span>
<span class="token attr-name">spring.cloud.consul.port</span><span class="token punctuation">=</span><span class="token attr-value">8500</span>
<span class="token comment"># 默认值为服务名，可更改</span>
<span class="token attr-name">spring.cloud.consul.discovery.service-name</span><span class="token punctuation">=</span><span class="token attr-value">${spring.application.name}</span>
</code></pre></div></li> <li><p>通用的服务注册中心注解（除Eureka），@EnableDisCoveryClient</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@EnableDiscoveryClient</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ConsulClientApplication</span> <span class="token punctuation">{</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">}</span>
</code></pre></div></li> <li><p>启动服务，查看services</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220117135656828.png" alt="image-20220117135656828"></p></li> <li><p>出错，consul-client无法正常响应server的心跳，但是需要手动引入健康检查的依赖，client才能响应server</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div></li> <li><p>（健康检查可以关闭）</p> <div class="language-properties extra-class"><pre class="language-properties"><code><span class="token attr-name">spring.cloud.consul.discovery.register-health-check</span><span class="token punctuation">=</span><span class="token attr-value">false</span>
</code></pre></div></li> <li><p>查看services</p> <p><img src="https://gitee.com/yangtao8453/picgo/raw/master/img/image-20220117140245242.png" alt="image-20220117140245242"></p></li></ol> <h2 id="eureka-vs-consul"><a href="#eureka-vs-consul" class="header-anchor">#</a> Eureka VS Consul</h2> <h3 id="cap"><a href="#cap" class="header-anchor">#</a> CAP</h3> <p>指的是在一个分布式系统中，<strong>一致性（Consistency）</strong>、<strong>可用性（Availability）</strong>、<strong>分区容错性（Partition tolerance）</strong>。CAP 原则指的是，这三个要素<strong>最多只能同时实现两点</strong>，不可能三者兼顾。</p> <ul><li>一致性（C）：在分布式系统中的所有数据备份，在同一时刻是否同样的值。</li> <li>可用性（A）：在集群中一部分节点故障后，集群整体是否还能响应客户端的读写请求。</li> <li>分区容忍性（P），就是高可用性，一个节点崩了，并不影响其它的节点。</li></ul> <h3 id="eureka-2"><a href="#eureka-2" class="header-anchor">#</a> Eureka</h3> <p>Eureka中没有使用任何的数据强一致性算法保证不同集群间的Server的数据一致，仅通过数据拷贝的方式争取注册中心数据的最终一致性，<strong>虽然放弃数据强一致性但是换来了Server的可用性</strong>，降低了注册的代价，<strong>提高了集群运行的健壮性</strong>。</p> <h3 id="consul-2"><a href="#consul-2" class="header-anchor">#</a> Consul</h3> <p>基于Raft算法，<strong>Consul提供强一致性的注册中心服务</strong>，但是由于<strong>Leader节点承担了所有的处理工作</strong>，势必加大了注册和发现的代价，<strong>降低了服务的可用性</strong>。通过Gossip协议，Consul可以很好地监控Consul集群的运行，同时可以方便通知各类事件，如Leader选择发生、Server地址变更等</p> <h3 id="对比"><a href="#对比" class="header-anchor">#</a> 对比</h3> <table><thead><tr><th style="text-align:center;">组件</th> <th style="text-align:center;">语言</th> <th style="text-align:center;">一致性算法</th> <th style="text-align:center;">健康检查</th></tr></thead> <tbody><tr><td style="text-align:center;">Eureka</td> <td style="text-align:center;">Java</td> <td style="text-align:center;">无</td> <td style="text-align:center;">支持</td></tr> <tr><td style="text-align:center;">Consul</td> <td style="text-align:center;">Golang</td> <td style="text-align:center;">Raft</td> <td style="text-align:center;">支持</td></tr></tbody></table></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/pages/back-end/springcloud-1-microservice.html" class="prev">
        微服务概述
      </a></span> <span class="next"><a href="/pages/back-end/springcloud-3-communicate.html">
        服务通信
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.eb84dcc4.js" defer></script><script src="/assets/js/2.3438093d.js" defer></script><script src="/assets/js/11.4e188f36.js" defer></script>
  </body>
</html>
